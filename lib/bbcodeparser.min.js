!function(a,b){return"function"==typeof define&&define.amd?define(["xregexp"],function(c){return a.BBCodeParser=b(a,c)}):"undefined"!=typeof exports?module.exports=b(a,XRegExp):a.BBCodeParser=b(a,a.XRegExp)}(this,function(a,b){var c,d;c={},c.VERSION="0.1.4";var e;e=function(){function a(){this.argsPattern=new RegExp('([^,"]+)|("[^"]+")',"ig"),this.regExSkeleton='(.*?)((\\[\\s*(%tags%)\\s*([= ]((\\s*(("[^"]+?")|([^,\\]"]+?))\\s*,)*(\\s*(("[^"]+?")|([^,"\\]]+?))\\s*)))?\\])|(\\[\\/\\s*((%tags%))\\s*\\]))',this.tags={}}return a.getAllTags=function(){return"string, b, u, s, i, mod, spoiler, code, img, quote, url, list, table, m, tex"},a.prototype.registerTag=function(a){return this.tags[a.tag]=a},a.prototype.generatePattern=function(){var a,c,d;return d=function(){var d,e;d=this.tags,e=[];for(a in d)c=d[a],e.push(b.escape(a));return e}.call(this).join("|"),b(this.regExSkeleton.replace(/%tags%/gi,d,"gi"),"imsg")},a.prototype.parse=function(a){var c,d,e,i,j,k,l,m,n,o,p,q,r,s,t,u,v;m=0,v=[],s=a.indexOf("["),l=a.lastIndexOf("]"),e="",k="";try{e=this.stringToHTML(a.substr(0,s)),k=this.stringToHTML(a.substr(l+1)),a=a.substr(s,l+1)}catch(w){}for(r=new h,i=r,o=this.generatePattern(),p=0;n=b.exec(a,o,p,"sticky");){if(p=n.index+n[0].length,n[1].length>0&&(t=new g,t.initialize(g.TYPE_STRING,this.stringToHTML(n[1])),v.push(t)),n[2].indexOf("[/")>-1)t=new g,t.initializeWithTag(g.TYPE_CLOSE,n[16].toLowerCase(),n[2]),v.push(t);else{if(c=[],n[6]&&n[6].length>0)for(;d=this.argsPattern.exec(n[6]);)c.push(d[0].replace(/\"/,""));t=new g,t.initializeWithArguments(g.TYPE_OPEN,n[4].toLowerCase(),n[2],c),v.push(t)}m=p}for(a.substr(m).length>0&&(t=new g(g.TYPE_STRING,this.stringToHTML(a.substr(m))),v.push(t));v.length>0;){if(v[0].type===g.TYPE_STRING)try{i=this.addString(i,v[0].text)}catch(w){switch(j=w,i.tag.invalidStringRecovery){case f.RECOVERY_ADD:t=new g,t.initialize(g.TYPE_OPEN,i.tag.invalidRecoveryAddTag),v.unshift(t);break;default:throw new Error("Unknown error")}continue}if(v[0].type===g.TYPE_OPEN)try{u=v[0],i=this.addStart(i,u.tag,u.args,u.text)}catch(w){switch(j=w,q=this.isAllowedAnywhere(i,v[0].tag)||i.tag.invalidStartRecovery===f.RECOVERY_ADD?i.tag.invalidStartRecovery:f.RECOVERY_STRING,this.isAllowedAnywhere(i,v[0].tag)&&i.tag.invalidStartRecovery===f.RECOVERY_ADD&&(q=f.RECOVERY_CLOSE),q){case f.RECOVERY_ADD:t=new g,t.initialize(g.TYPE_OPEN,i.tag.invalidRecoveryAddTag),v.unshift(t);break;case f.RECOVERY_CLOSE:t=new g,t.initialize(g.TYPE_CLOSE,i.tag.tag),v.unshift(t);break;case f.RECOVERY_STRING:v[0].type=g.TYPE_STRING;break;default:throw new Error("Unkown Error")}continue}if(v[0].type===g.TYPE_CLOSE)try{u=v[0],i=this.addEnd(i,u.tag,u.text)}catch(w){switch(j=w,q=this.isOpen(i,v[0].tag)?i.tag.invalidEndRecovery:f.RECOVERY_STRING){case f.RECOVERY_REOPEN:t=new g,t.initialize(g.TYPE_CLOSE,i.tag.tag),v.unshift(t),t=new g,t.initialize(g.TYPE_OPEN,i.tag.tag),v.splice(2,0,t);break;case f.RECOVERY_CLOSE:t=new g,t.initialize(g.TYPE_CLOSE,i.tag.tag),v.unshift(t);break;case f.RECOVERY_STRING:v[0].type=g.TYPE_STRING;break;default:throw new Error("Unkown Error")}continue}v.shift()}return e+r.toString()+k},a.prototype.addString=function(a,b){var c;if(!a.isRoot()&&-1===a.tag.allowedTags.indexOf("string"))throw new InvalidTokenException;return c=new h,c.initialize(b),c.parent=a,a.children.push(c),a},a.prototype.addStart=function(a,b,c,d){var e,f;if(!a.isRoot()&&-1===a.tag.allowedTags.indexOf(b))throw new InvalidTokenException;return f=this.tags[b],e=new h,e.initializeWithRaw(f,c,d),e.parent=a,a.children.push(e),e},a.prototype.addEnd=function(a,b,c){if(a.isRoot()||b!==a.tag.tag)throw new InvalidTokenException;return a.close(c)},a.prototype.isOpen=function(a,b){return a.isRoot()?!1:a.tag.tag===b?!0:this.isOpen(a.parent,b)},a.prototype.isAllowedAnywhere=function(a,b){return a.isRoot()?!1:-1!==a.tag.allowedTags.indexOf(b)?!0:this.isAllowedAnywhere(a.parent,b)},a.prototype.stringToHTML=function(a){return a=a.replace(/</g,"&lt;"),a=a.replace(/>/g,"&gt;"),a.replace(/\n/g,"<br>\n")},a}();var f;f=function(){function a(){this.invalidEndRecovery=a.RECOVERY_STRING,this.invalidStringRecovery=a.RECOVERY_NONE,this.invalidStartRecovery=a.RECOVERY_STRING,this.invalidRecoveryAddTag="",this.tag=this.tag||null,this.description=this.description||"",this.allowedTags=this.allowedTags||[],this.text=this.text||""}return a.RECOVERY_NONE=0,a.RECOVERY_STRING=1,a.RECOVERY_CLOSE=2,a.RECOVERY_REOPEN=3,a.RECOVERY_ADD=4,a.prototype.initialize=function(a,b){return this.tag=a,this.name=b,this.allowTags(e.getAllTags())},a.prototype.initializeWithAllowedTags=function(a,b,c){return this.tag=a,this.name=b,this.allowTags(c)},a.prototype.setInvalidStartRecovery=function(a){return this.invalidStartRecovery=a},a.prototype.setInvalidEndRecovery=function(a){return this.invalidEndRecovery=a},a.prototype.setInvalidStringRecovery=function(a){return this.invalidStringRecovery=a},a.prototype.setInvalidRecoveryTag=function(a){return this.invalidRecoveryAddTag=a},a.prototype.html=function(){return console.error("You have to implement an html method")},a.prototype.allowTags=function(a){var b;return this.allowedTags=function(){var c,d,e,f;for(e=a.split(","),f=[],c=0,d=e.length;d>c;c++)b=e[c],f.push(b.replace(" ",""));return f}()},a}();var g;g=function(){function a(){this.type=null,this.text=null,this.tag=null,this.args=null}return a.TYPE_STRING=0,a.TYPE_OPEN=1,a.TYPE_CLOSE=2,a.prototype.initialize=function(b,c){return this.type=b,this.type===a.TYPE_STRING?this.text=c:(this.tag=c,this.type===a.TYPE_OPEN&&(this.text="["+this.tag+"]"),this.type===a.TYPE_CLOSE?this.text="[/"+this.tag+"]":void 0)},a.prototype.initializeWithTag=function(a,b,c){return this.type=a,this.tag=b,this.text=c},a.prototype.initializeWithArguments=function(a,b,c,d){return this.type=a,this.tag=b,this.text=c,this.args=d},a}();var h;h=function(){function a(){this.children=[],this.parent=null,this.tag=null,this.text=null,this.args=null,this.rawStart=null,this.rawEnd=null,this.invalid=!1}return a.prototype.initialize=function(a){return this.text=a},a.prototype.initializeWithRaw=function(a,b,c){return this.tag=a,this.args=b,this.rawStart=c},a.prototype.close=function(a){return this.rawEnd=a?a:"[/"+this.tag.tag+"]",this.parent},a.prototype.hasTag=function(){return null!==this.tag},a.prototype.isRoot=function(){return null===this.tag&&null===this.text},a.prototype.isString=function(){return null!==this.text},a.prototype.isInvalid=function(){return this.invalid},a.prototype.toString=function(){var a,b;return this.isString()?this.text:(b=function(){var b,c,d,e;for(d=this.children,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.toString());return e}.call(this).join(""),this.isRoot()?b:""===b?b:this.isInvalid()?this.rawStart+b+this.rawEnd:this.tag.html(b,this.args))},a}();var i,j={}.hasOwnProperty,k=function(a,b){function c(){this.constructor=a}for(var d in b)j.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};i=function(a){function b(){b.__super__.constructor.apply(this,arguments),this.allowed?this.initializeWithAllowedTags(this.tag,this.name,this.allowed):this.initialize(this.tag,this.name)}return k(b,a),b.prototype.initialize=function(){return b.__super__.initialize.apply(this,arguments),this.setInvalidStartRecovery(f.RECOVERY_CLOSE),this.setInvalidEndRecovery(f.RECOVERY_REOPEN)},b.prototype.initializeWithAllowedTags=function(){return b.__super__.initializeWithAllowedTags.apply(this,arguments),this.setInvalidStartRecovery(f.RECOVERY_CLOSE),this.setInvalidEndRecovery(f.RECOVERY_REOPEN)},b.prototype.html=function(a){return this.format?this.format.replace(/%content%/,a):""},b}(f);var l,j={}.hasOwnProperty,k=function(a,b){function c(){this.constructor=a}for(var d in b)j.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};l=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return k(b,a),b.prototype.tag="b",b.prototype.name="bold",b.prototype.format="<strong>%content%</strong>",b}(i);var m,j={}.hasOwnProperty,k=function(a,b){function c(){this.constructor=a}for(var d in b)j.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};m=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return k(b,a),b.prototype.tag="i",b.prototype.name="italic",b.prototype.format="<em>%content%</em>",b}(i);var n,j={}.hasOwnProperty,k=function(a,b){function c(){this.constructor=a}for(var d in b)j.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};n=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return k(b,a),b.prototype.tag="s",b.prototype.name="strike",b.prototype.format="<del>%content%</del>",b}(i);var o,j={}.hasOwnProperty,k=function(a,b){function c(){this.constructor=a}for(var d in b)j.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};o=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return k(b,a),b.prototype.tag="u",b.prototype.name="underline",b.prototype.format="<u>%content%</u>",b}(i);var p,j={}.hasOwnProperty,k=function(a,b){function c(){this.constructor=a}for(var d in b)j.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};p=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return k(b,a),b.prototype.tag="mod",b.prototype.name="mod",b.prototype.format='<span class="mod">%content%</span>',b}(i);var q,j={}.hasOwnProperty,k=function(a,b){function c(){this.constructor=a}for(var d in b)j.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};q=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return k(b,a),b.prototype.tag="trigger",b.prototype.name="trigger",b.prototype.format='<span class="trigger">%content%</span>',b}(i);var r,j={}.hasOwnProperty,k=function(a,b){function c(){this.constructor=a}for(var d in b)j.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};r=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return k(b,a),b.prototype.tag="spoiler",b.prototype.name="spoiler",b.prototype.format='<div class="spoiler"><div>%content%</div></div>',b}(i);var s,j={}.hasOwnProperty,k=function(a,b){function c(){this.constructor=a}for(var d in b)j.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};s=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return k(b,a),b.prototype.tag="code",b.prototype.name="code",b.prototype.html=function(a){return a=a.replace(/\<br\>/gi,""),'<div class="code">%content%</div>'.replace("%content%",a)},b}(i);var t,j={}.hasOwnProperty,k=function(a,b){function c(){this.constructor=a}for(var d in b)j.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};t=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return k(b,a),b.prototype.tag="m",b.prototype.name="monospace",b.prototype.html=function(a){return a=a.replace(/\<br\>/gi,""),'<span class="inline-code">%content%</span>'.replace("%content%",a)},b}(i);var u,j={}.hasOwnProperty,k=function(a,b){function c(){this.constructor=a}for(var d in b)j.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};u=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return k(b,a),b.prototype.tag="url",b.prototype.name="link",b.prototype.allowed="string, b, u, s, i, mod, img, url, list, table, m",b.prototype.html=function(a,b){var c;return c=a,b.length>0&&(c=b[0]),"http"!==c.substr(0,4)&&(c="http://"+c),'<a href="'+c+'">'+a+"</a>"},b}(i);var v,j={}.hasOwnProperty,k=function(a,b){function c(){this.constructor=a}for(var d in b)j.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};v=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return k(b,a),b.prototype.tag="img",b.prototype.name="image",b.prototype.allowed="string",b.prototype.format='<div class="image not-loaded" data-image="%content%"></div>',b}(i);var w,j={}.hasOwnProperty,k=function(a,b){function c(){this.constructor=a}for(var d in b)j.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};w=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return k(b,a),b.prototype.tag="video",b.prototype.name="video",b.prototype.allowed="string",b.prototype.html=function(a){return a.match(/youtu\.?be/)?'<div class="video youtube" data-video="'+a+'"></div>':'<div class="video" data-video="'+a+'"></div>'},b}(i);var x,j={}.hasOwnProperty,k=function(a,b){function c(){this.constructor=a}for(var d in b)j.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};x=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return k(b,a),b.prototype.tag="quote",b.prototype.name="quote",b.prototype.html=function(a,b){return 3===b.length?'<blockquote data-thread-id="'+b[0]+'" data-post-id="'+b[1]+'" data-author="'+b[2]+'">'+a+"</blockquote>":"<blockquote>"+a+"</blockquote>"},b}(i);var y,j={}.hasOwnProperty,k=function(a,b){function c(){this.constructor=a}for(var d in b)j.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};y=function(a){function b(){b.__super__.constructor.apply(this,arguments),this.initializeWithAllowedTags("list","list","*"),this.setInvalidStartRecovery(f.RECOVERY_ADD),this.setInvalidEndRecovery(f.RECOVERY_CLOSE),this.setInvalidStringRecovery(f.RECOVERY_ADD),this.setInvalidRecoveryTag("*")}return k(b,a),b.prototype.html=function(a){return"<ul>"+a+"</ul>"},b}(f);var z,j={}.hasOwnProperty,k=function(a,b){function c(){this.constructor=a}for(var d in b)j.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};z=function(a){function b(){b.__super__.constructor.apply(this,arguments),this.initialize("*","listitem"),this.setInvalidStartRecovery(f.RECOVERY_CLOSE),this.setInvalidEndRecovery(f.RECOVERY_CLOSE)}return k(b,a),b.prototype.html=function(a){return 0===a.replace("<br>","").trim().length?"":"<li>"+a+"</li>"},b}(f);var A,j={}.hasOwnProperty,k=function(a,b){function c(){this.constructor=a}for(var d in b)j.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};A=function(a){function b(){b.__super__.constructor.apply(this,arguments),this.initializeWithAllowedTags("table","table","--"),this.setInvalidStartRecovery(f.RECOVERY_ADD),this.setInvalidEndRecovery(f.RECOVERY_CLOSE),this.setInvalidStringRecovery(f.RECOVERY_ADD),this.setInvalidRecoveryTag("--")}return k(b,a),b.prototype.html=function(a){return"<table>"+a+"</table>"},b}(f);var B,j={}.hasOwnProperty,k=function(a,b){function c(){this.constructor=a}for(var d in b)j.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};B=function(a){function b(){b.__super__.constructor.apply(this,arguments),this.initializeWithAllowedTags("--","tablerow","||"),this.setInvalidStartRecovery(f.RECOVERY_ADD),this.setInvalidEndRecovery(f.RECOVERY_CLOSE),this.setInvalidStringRecovery(f.RECOVERY_ADD),this.setInvalidRecoveryTag("||")}return k(b,a),b.prototype.html=function(a){return"<tr>"+a+"</tr>"},b}(f);var C,j={}.hasOwnProperty,k=function(a,b){function c(){this.constructor=a}for(var d in b)j.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};return C=function(a){function b(){b.__super__.constructor.apply(this,arguments),this.initialize("||","tablecol"),this.setInvalidStartRecovery(f.RECOVERY_CLOSE),this.setInvalidEndRecovery(f.RECOVERY_CLOSE)}return k(b,a),b.prototype.html=function(a){return"<td>"+a+"</td>"},b}(f),d=new e,d.registerTag(new l),d.registerTag(new t),d.registerTag(new o),d.registerTag(new n),d.registerTag(new m),d.registerTag(new s),d.registerTag(new r),d.registerTag(new p),d.registerTag(new q),d.registerTag(new u),d.registerTag(new v),d.registerTag(new w),d.registerTag(new x),d.registerTag(new y),d.registerTag(new z),d.registerTag(new A),d.registerTag(new B),d.registerTag(new C),d});
//# sourceMappingURL=bbcodeparser.map